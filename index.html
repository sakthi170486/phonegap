<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Navigator</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="css/bootstrap.css">
		<link rel="stylesheet" href="css/jquery.mCustomScrollbar.css">
	</head>
	<body>
		<div class="inner-content">
			<div class="maincontent bg-color">
			</div>
		</div>
	</body>
	<script id="welcome-tpl" type="text/x-handlebars-template">
		<div class="container h-100">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12 mx-auto text-center" id="lgmid">
					<img src="img/logo.png" class="img-responsive" alt="">
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>
	<script id="home-tpl" type="text/x-handlebars-template">
		<div class="text-white text-center mt-5">
			<h1>Welcome to Navigator</h1>
			<p>Maintain the customer details!</p> 
		</div>
		<hr/>
		<div class="container">
			<div class="row">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12">
					<a class="d-block m-3 pt-3 text-white lnk" href="SignUp"><h4><i class="fa fa-plane"></i> Sign Up</h4></a>
					<a class="d-block m-3 pt-3 text-white" href="sample.html"><h4><i class="fa fa-lock"></i> Sign In</h4></a>
					<a class="d-block m-3 pt-3 text-white lnk" href=""><h4><i class="fa fa-video-camera"></i> Watch Video</h4></a>
				</div>
				<div class="col-md-1">
				</div>
			</div>
		</div>
	</script>
	<script id="signup-tpl" type="text/x-handlebars-template">
		<div class="container h-100 mt-3">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12 mx-auto">						
					<h3 class="text-center text-white">SIGN UP</h3>
					<div class="form-group cam text-center text-white">
						<a href="" data-toggle="modal" data-target="#photo"><img src="img/camera.png" id='profimg' class="img-responsive"></a><br/>
						<span>upload photo</span><br/>
						<hr/>
					</div>
					<div id="photo" class="modal fade" role="dialog">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<p class="modal-title text-center w-100 font-weight-bold">Upload Photo</p>
									<span class="close" data-dismiss="modal">&times;</span>
									
								</div>
								<div class="modal-body text-center">
									<button id='but_take' class="btn btn-outline-primary">Take photo</button><br/>
									<button id='but_select' class="btn btn-outline-info mt-1">Select photo from Gallery</button>
									
								</div>
							</div>
						</div>	
					</div>
					<form action="#" class="text-white" name="reg" id="reg">
						<div class="form-group">
							<input type="text" class="form-control" required placeholder="Company Name *" name="cname" id="cname">
						</div>
						<div class="form-group">
							<input type="text" class="form-control" required placeholder="Your Name *" name="name" id="name">
						</div>
						<div class="form-group">
							<input type="tel" class="form-control" required placeholder="Mobile Number *" name="mobile" id="mobile">
						</div>
						<div class="form-group">
							<input type="tel" class="form-control" placeholder="Alternative Number" name="altmobile" id="altmobile">
						</div>
						<div class="form-group">
							<input type="email" class="form-control" placeholder="Email address *" required name="email" id="email">
							<input type="hidden" class="form-control" name="imgname" id="imgname">
							<input type="hidden" class="form-control" name="simgname" id="simgname">
							
						</div>	
						<div class="form-group text-center">
						<a id="" href="Home" class="btn form-btn pt-3 lnk">Home</a>
						<button type="submit" class="btn form-btn reg" name="insert" id="insert" >Submit</button>
						</div>
					</form>	
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>
	<script id="signin-tpl" type="text/x-handlebars-template">
		<div class="container h-100" id="lgmid">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12 mx-auto">
					<h3 class="text-center text-white">SIGN IN</h3><br/>
					<form action="#" class="text-white">								
						<div class="form-group">
							<label for="mobile">Enter Mobile Number: *</label>
							<input type="tel" class="form-control" required name="umobile" id="umobile" autocomplete="off">
						</div>									
						<div class="form-group text-center">
							<a id="" href="Home" class="btn form-btn pt-3 lnk">Home</a>
							<button type="submit" class="btn form-btn lgn">Login</button>
						</div>
					</form>	
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>
	<script id="otp-tpl" type="text/x-handlebars-template">
		<div class="container h-100" id="lgmid">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block"></div>
				<div class="col-md-10 col-sm-12 mx-auto">
					<h3 class="text-center text-white">SIGN IN</h3><br/>
					<form action="#" class="text-white">								
						<div class="form-group">
							<label for="mobile">Enter OTP: *</label>
							<input type="password" class="form-control" required id="otp">
							<input type="hidden" name="cumobile" id="cumobile">
						</div>									
						<div class="form-group text-center">
						<a id="" href="Home" class="btn form-btn pt-3 lnk">Home</a>
						<button type="submit" class="btn form-btn lgnotp">Submit</button>
						</div>
					</form>	
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>	
	<script src="phonegap.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
	<script src="js/jquery.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>	
	<script src="lib/handlebars.js"></script>
	<script src="js/main.js"></script> 
	<script src="js/jquery-ui.js"></script>
	<script src="js/imgcache.js"></script>
	<!-- <script src="js/imgcache-promise.js"></script> -->
	<script type="text/javascript">
		// If logged in then move to dashboard
		window.onload = function()
		{
			var lgn=window.localStorage.getItem('loginstatus');
			if(lgn == 'true')
			{
				window.location.href="dashboard.html";
			}
		}
		// window.openDatabase("database-name","version","database description","database size in bytes")
		//var db = window.openDatabase("customerdb", "1.0", "customer database", 1000000); //will create database Dummy_DB or open it
		
		
		
		document.addEventListener("deviceready", onDeviceReady, false);
		
		function onDeviceReady() {
			var db = window.openDatabase("customerdb", "1.1", "customer database", 1000000);	
			//db = sqlitePlugin.openDatabase({name: 'cusdirectory.db'});
			// Create Table
			db.transaction(populateDB, errorCB, successCB);				
			
			// write log to console
			ImgCache.options.debug = true;

			// increase allocated space on Chrome to 25MB, default was 10MB
			ImgCache.options.chromeQuota = 25*1024*1024;
		
			// Instead of using the PERSISTENT or TEMPORARY filesystems, use one of the
			// Cordova File plugin's app directories
			// (https://github.com/apache/cordova-plugin-file#where-to-store-files).
			// This is friendlier in a mobile application environment as we are able to store
			// files in the correct platform-recommended/enforced directories.
			// WARNING: Make sure this points to a __directory__!
			// NOTE: Only has effect when running in a Cordova environment			
			ImgCache.options.cordovaFilesystemRoot = cordova.file.dataDirectory;	
			ImgCache.init();			
		}
		
		
		function checkInternet() {
			var i=0;
			var networkState = navigator.connection.type;
			if(networkState == Connection.NONE || networkState == Connection.UNKNOWN) {
				//onConnexionError();
				i=0;

			} else {
			   i=1;
			}
			return i;
		}
		// Change image source and upload photo to server
		function onSuccess(imageURI) {
			// Set image source
			var image = document.getElementById('profimg');
			image.src = imageURI  + '?' + Math.random();

			var options = new FileUploadOptions();
			options.fileKey = "file";
			options.fileName = imageURI.substr(imageURI.lastIndexOf('/') + 1);
			options.mimeType = "image/jpeg";

			var params = {};
			params.value1 = "test";
			params.value2 = "param";

			options.params = params;
			options.chunkedMode = false;
			
			var target = $('#profimg');
			ImgCache.isCached(target.attr('src'), function(path, success) {
			  if (success) {
				// already cached				
				ImgCache.useCachedFile(target);
			  } else {
				// not there, need to cache the image
					ImgCache.cacheFile(imageURI, function () {					
					ImgCache.useCachedFile(target);
				});
			  }			 
			  $('#imgname').val(target.attr('src'));
			});	
			/*var internet = checkInternet();
			if(internet > 0)
			{
				var ft = new FileTransfer();
				ft.upload(imageURI, "http://www.azillesoft.com/phonegap/database/upload.php", function(result){
					//alert('successfully uploaded ' + result.response);
					$('#simgname').val(result.response);
					$('#photo').modal('hide');				
				}, function(error){
					alert('error : ' + JSON.stringify(error));
				}, options);
			}*/
			
			$('#photo').modal('hide');
		}
		
		function onFail(message) {
			alert('Failed because: ' + message);
		}
		
		

		

		function populateDB(tx){
		
			tx.executeSql('CREATE TABLE IF NOT EXISTS customerdetails (id INTEGER PRIMARY KEY AUTOINCREMENT, companyid INTEGER NOT NULL , name TEXT NOT NULL, emailid TEXT NOT NULL, phonenumber TEXT NOT NULL, address TEXT, city TEXT DEFAULT NULL, state TEXT DEFAULT NULL, country TEXT DEFAULT NULL, pincode INTEGER NOT NULL, source INTEGER NOT NULL DEFAULT 0, dateofcreation TEXT NOT NULL, dateofupdate TEXT NOT NULL)');
			
			tx.executeSql('CREATE TABLE IF NOT EXISTS userdetails (id INTEGER PRIMARY KEY AUTOINCREMENT, company_name TEXT NOT NULL , name TEXT NOT NULL, emailid TEXT NOT NULL, phonenumber TEXT NOT NULL, alternumber TEXT, profilepic TEXT DEFAULT NULL, loginaccess TEXT DEFAULT NULL, accessexpiry TEXT DEFAULT NULL, lastlogin TEXT DEFAULT NULL,dateofcreation TEXT NOT NULL, dateofupdate TEXT NOT NULL)');			
		}
		
		function checkMobile(){
			var id=0;
			var ph=1;
			var db = window.openDatabase("customerdb", "1.1", "customer database", 1000000);
			db.transaction(function(tx){
				tx.executeSql('select id from userdetails where phonenumber="'+ph+'"',[],function(tx1,result){
					var len = result.rows.length;					
					/*for (var i=0; i<len; i++){*/
						id = result.rows.item(0).id;						
					/*}*/
					
				},errorCB);
			}, errorCB, successCB);
			alert(id);
			return id;
		}
		
		function checkOTP(ph,otp){
			var id=0;	
			var db = window.openDatabase("customerdb", "1.1", "customer database", 1000000);			
			db.transaction(function(tx){
				tx.executeSql("select id from userdetails where phonenumber=? and loginaccess=?",[ph,otp],function(tx1,result){
					var len = result.rows.length;
					for (var i=0; i<len; i++){
						id = result.rows.item(i).id;						
					}
				},errorCB);
			}, errorCB, successCB);
			
			return id;
		}
		
		

		function errorCB(err) {
			alert("Error processing SQL: "+err.code);
		}

		function successCB() {
		 //alert("success!");
		}
		
	
		// open the corresponding page
		$('body').on('click','.lnk',function(e){
			e.preventDefault();
			// Most effect types need no options passed by default			
			var l=$(this).attr('href').toLowerCase();
			/*if(l != '#' && l != '')
			{
				if($('#simgname').val())
				{		
					var v = $('#simgname').val();
					if(v.length > 0)
					{
						var internet = checkInternet();
						if(internet > 0)
						{
							$.ajax({
								type: "POST",
								url:"http://www.azillesoft.com/phonegap/database/checkuimg.php",
								data : 'm='+v, // post data || get data
								crossDomain: true,
								cache: false,
								success: function(data){
									if(data == 0)
									{
										$('#profimg').attr('src','img/camera.png');
									}
									//console.log(data);						
								}
							});
						}
					}
				}*/
				var template = Handlebars.compile($("#"+l+"-tpl").html());
				
				if(l == 'home' || l == 'welcome'){
					window.localStorage.setItem('firstpage',1);}
				else
				{
					window.localStorage.setItem('firstpage',0);
				}
			
				var options = {direction:'right'};
				$('.maincontent').html('');
				$( ".maincontent" ).effect( 'slide', options, 300, function(){
					$('.maincontent').html(template);
				});
			/*}*/
			
		});
		
		// Check mobile number already registered or not
		$("body").on('blur','#mobile',function(e){
			var v=$(this).val();
			var im = $('#simgname').val();
			if(v.length > 0 )
			{
				/*
				var internet = checkInternet();
				if(internet > 0)
				{
					alert('2');
					$.ajax({
						type: "POST",
						url:"http://www.azillesoft.com/phonegap/database/checkumobile.php",
						data : 'm='+v+'&im='+im, // post data || get data
						crossDomain: true,
						cache: false,
						success: function(data){
							if(data == "exists")
							{			
								$('#profimg').attr('src','img/camera.png');
								alert("Mobile number already registered.");
								$("#mobile").val('');
								$("#reg")[0].reset();
								var signinTpl = Handlebars.compile($("#signin-tpl").html());	
								$('.maincontent').html(signinTpl);							
							}						
						}
					});
				}
				else
				{*/
					var c = checkMobile(v);
					if(c > 0)
					{						
						$('#profimg').attr('src','img/camera.png');
						alert("Mobile number already registered.");
						$("#mobile").val('');
						$("#reg")[0].reset();
						var signinTpl = Handlebars.compile($("#signin-tpl").html());	
						$('.maincontent').html(signinTpl);
					}
				/*}*/
			}
		});
	
		// take picture from camera
		$('body').on('click','#but_take',function(){
			navigator.camera.getPicture(onSuccess, onFail, { quality: 20,
				destinationType: Camera.DestinationType.FILE_URL 
			});
		});

		// upload select 
		$('body').on('click','#but_select',function(){
			navigator.camera.getPicture(onSuccess, onFail, { quality: 50,
				sourceType: Camera.PictureSourceType.PHOTOLIBRARY, 
				allowEdit: true,
				destinationType: Camera.DestinationType.FILE_URI
			});
		});           
		
		// insert data to server
		$("body").on('click','#insert',function(e){
			e.preventDefault();	
			var cname=$("#cname").val();
			var name=$("#name").val();
			var mobile=$("#mobile").val();
			var amobile=$("#altmobile").val();
			var email=$("#email").val();
			var cimgname=$("#imgname").val();			
			var imgname=$("#simgname").val();
			
			var today = new Date();
			var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
			var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
			var dt = date+' '+time;
			
			if($.trim(cname).length > 0 && $.trim(name).length > 0 && $.trim(mobile).length > 0 && $.trim(email).length > 0)
			{				
				 atpos = email.indexOf("@");
				 dotpos = email.lastIndexOf(".");				 
				 if (atpos < 1 || ( dotpos - atpos < 2 )) {
					alert("Please enter correct email ID")
					$("#email").focus() ;
					return false;
				 }
				 if(isNaN( mobile ) ||$.trim(mobile).length != 10 ) {					
					alert( "Please provide a valid mobile number." );
					$("#mobile").focus() ;
					return false;
				 }
				if( amobile != '' && $.trim(amobile).length != 10 ) {					
					alert( "Please provide a valid alternate number." );
					$("#altmobile").focus() ;
					return false;
				 }		
				$("#insert").text('Connecting...');
				var internet = checkInternet();
				/*if(internet > 0)
				{
					$.ajax({
						type: "POST",
						url:"http://www.azillesoft.com/phonegap/database/insert.php",
						//dataType : 'json', // data type
						data : $("#reg").serialize(), // post data || get data
						crossDomain: true,
						cache: false,
						beforeSend: function(){ $("#insert").text('Connecting...');},
						success: function(data){
							if(data == "fail")
							{				
								delImg();								
							}
						}
					});					
				}	*/		
					var db = window.openDatabase("customerdb", "1.1", "customer database", 1000000);
				db.transaction(function(tx){
					var qry="INSERT INTO userdetails (company_name,name,phonenumber,alternumber,emailid,profilepic,dateofcreation,dateofupdate) VALUES (?,?,?,?,?,?,?,?)";
					tx.executeSql(qry, [cname,name,mobile,amobile,email,cimgname,dt,dt], function(tx1,result){
						alert("inserted");
						$("#insert").text('Submit');
						$("#reg")[0].reset();
						var signinTpl = Handlebars.compile($("#signin-tpl").html());	
						$('.maincontent').html(signinTpl);
					},function(error){
						ImgCache.removeFile(cimgname);
						$('#profimg').attr('src','img/camera.png');
						alert("error");
					});
				}, errorCB, successCB);	
								
				
			}
			else 
			{
				
				alert("Enter all the required fields");
				//$("#reg")[0].reset();
			}			
			return false;
		});
		
		
		// Check mobile number registered or not
		$("body").on('blur','#umobile',function(e){
			var v=$(this).val();
			if(v.length > 0 )
			{
				/*var internet = checkInternet();
				if(internet > 0)
				{
					$.ajax({
						type: "POST",
						url:"http://www.azillesoft.com/phonegap/database/checkumobile.php",
						data : 'm='+v, // post data || get data
						crossDomain: true,
						cache: false,
						success: function(data){
							if(data == 0)
							{
								var c = checkMobile(v);
								if(c > 0)
								{
									db.transaction(function(tx){
										tx.executeSql("select company_name,name,phonenumber,alternumber,emailid,profilepic,dateofcreation,dateofupdate from userdetails",[],function(tx1,result){
											var len = result.rows.length;
											if(len >0)
											{
												var options = new FileUploadOptions();
												var cname = result.rows.item(0).company_name;
												var name = result.rows.item(0).name;
												var pnum = result.rows.item(0).phonenumber;
												var apnum = result.rows.item(0).alternumber;
												var pic = result.rows.item(0).profilepic;
												var email = result.rows.item(0).emailid;
												
												var ft = new FileTransfer();
												ft.upload(pic, "http://www.azillesoft.com/phonegap/database/upload.php", function(result){
													pic = result.response;	
												}, function(error){
													alert('error : ' + JSON.stringify(error));
												}, options);
												
												$.ajax({
													type: "POST",
													url:"http://www.azillesoft.com/phonegap/database/insert.php",
													data : 'cname='+cname+'&name='+name+'&mobile='+pnum+'&altmobile='+apnum+'&email='+email+'&imgname='+pic, // post data || get data
													crossDomain: true,
													cache: false,
													success: function(data){
														//success
													}
												});										
											}
										},function(error){});
									}, function(error){}, successCB);
								}
								else
								{
									alert("Mobile number not registered. Enter Registered mobile Number");
									//$("#umobile").focus();
								}
							}
							else
							{
								db.transaction(function(tx){
									tx.executeSql("select company_name,name,phonenumber,alternumber,emailid,profilepic,dateofcreation,dateofupdate from userdetails",[],function(tx1,result){
										var len = result.rows.length;
										if(len >0)
										{
											var options = new FileUploadOptions();
											var cname = result.rows.item(0).company_name;
											var name = result.rows.item(0).name;
											var pnum = result.rows.item(0).phonenumber;
											var apnum = result.rows.item(0).alternumber;
											var pic = result.rows.item(0).profilepic;
											var email = result.rows.item(0).emailid;
											
											var ft = new FileTransfer();
											ft.upload(pic, "http://www.azillesoft.com/phonegap/database/upload.php", function(result){
												pic = result.response;	
											}, function(error){
												alert('error : ' + JSON.stringify(error));
											}, options);
											
											$.ajax({
												type: "POST",
												url:"http://www.azillesoft.com/phonegap/database/update.php",
												data : 'eid='+data+'&ecname='+cname+'&ename='+name+'&emobile='+pnum+'&altmobile='+apnum+'&eemail='+email+'&eimgname='+pic, // post data || get data
												crossDomain: true,
												cache: false,
												success: function(data){
													//success
												}
											});										
										}
									},function(error){});
								}, function(error){}, successCB);
							}
						}
					});
				}
				else
				{*/
					var c = checkMobile(v);
					if(c == 0)
					{
						alert("Mobile number not registered. Enter Registered mobile Number");
						//$("#umobile").focus();
					}
				/*}*/
			}
		});
		
		// Send OTP to registered mobile
		$("body").on('click','.lgn',function(e){
			e.preventDefault();
			var v=$('#umobile').val();
			if(v.length > 0)
			{
				/*$.ajax({
					type: "POST",
					url:"http://www.azillesoft.com/phonegap/database/sendotp.php",
					data : 'm='+v, // post data || get data
					crossDomain: true,
					cache: false,
					beforeSend: function(){
						SpinnerDialog.show(null, "Processing");
					},
					success: function(data){
						SpinnerDialog.hide();
						if(data == 0)
						{
							alert("Mobile number not registered. Enter Registered mobile Number");							
							$("#umobile").val('').focus();
						}
						else
						{
							alert("OTP has been sent to your email.");
							var otpTpl = Handlebars.compile($("#otp-tpl").html());	
							$('.maincontent').html(otpTpl);
							$('#cumobile').val(v);
						}						
					}					
				});*/
				var otpTpl = Handlebars.compile($("#otp-tpl").html());	
				$('.maincontent').html(otpTpl);
				$('#cumobile').val(v);
			}
			else
			{
				alert("Enter mobile number.");
			}
		});
		
		// Check OTP 
		$("body").on('click','.lgnotp',function(e){
			e.preventDefault();
			var m=$('#cumobile').val();
			var o=$('#otp').val();
			if(o.length > 0)
			{
				/*var internet = checkInternet();
				if(internet > 0)
				{
					$.ajax({
						type: "POST",
						url:"http://www.azillesoft.com/phonegap/database/checkotp.php",
						data : 'm='+m+'&o='+o, // post data || get data
						crossDomain: true,
						cache: false,
						beforeSend: function(){
							SpinnerDialog.show(null, "Processing");
						},
						success: function(data){
							SpinnerDialog.hide();
							if(data == 0)
							{
								alert("Incorrect OTP");							
								$("#otp").val('').focus();
							}
							else
							{
								window.localStorage.setItem('loginstatus','true');
								window.localStorage.setItem('lgnid',data);
								window.localStorage.setItem('uid',m);
								window.location.href="dashboard.html";
							}						
						}
					});
				}
				else
				{*/
				
					//var cotp=checkOTP(m,o);
					if(o == '1234')
					{		
						var today = new Date();
						var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
						var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
						var dt = date+' '+time;
						var db = window.openDatabase("customerdb", "1.1", "customer database", 1000000);
						db.transaction(function(tx){					
							tx.executeSql("UPDATE userdetails SET lastlogin=? where phonenumber=?",[dt,m],function(tx1,result){
								//success
								window.localStorage.setItem('loginstatus','true');
								window.localStorage.setItem('lgnid',checkMobile(m));
								window.localStorage.setItem('uid',m);
								window.location.href="sample.html";
							},function(error){								
								alert("Incorrect OTP");							
								$("#otp").val('').focus();
							});
						}, errorCB, successCB);							
					}
				/*}*/
			}
			else
			{
				alert("Enter OTP.");
			}
		});
	
	
	// Delete image from server using cordova plugin file	
	function delImg()
	{
		var path = "http://www.azillesoft.com/phonegap/database/upload";
		var filename = $('#simgname').val();
		window.resolveLocalFileSystemURL(path, function(dir) {
			dir.getFile(filename, {create:false}, function(fileEntry) {
					  fileEntry.remove(function(){
						  // The file has been removed succesfully
					  },function(error){
						  // Error deleting the file
					  },function(){
						 // The file doesn't exist
					  });
			});
		});
	}
 </script>
</html>