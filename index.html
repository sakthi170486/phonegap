<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Navigator</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="css/bootstrap.css">
		<link rel="stylesheet" href="css/jquery.mCustomScrollbar.css">
	</head>
	<body>
		<div class="inner-content">
			<div class="maincontent bg-color">
			</div>
		</div>
	</body>
	<script id="welcome-tpl" type="text/x-handlebars-template">
		<div class="container h-100">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12 mx-auto text-center" id="lgmid">
					<img src="img/logo.png" class="img-responsive" alt="">	
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>
	<script id="home-tpl" type="text/x-handlebars-template">
		<div class="text-white text-center mt-5">
			<h1>Welcome to Navigator</h1>
			<p>Maintain the customer details!</p> 
		</div>
		<hr/>
		<div class="container">
			<div class="row">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12">
					<a class="d-block m-3 pt-3 text-white lnk" href="SignUp"><h4><i class="fa fa-plane"></i> Sign Up</h4></a>
					<a class="d-block m-3 pt-3 text-white lnk" href="SignIn"><h4><i class="fa fa-lock"></i> Sign In</h4></a>
					<a class="d-block m-3 pt-3 text-white lnk" href=""><h4><i class="fa fa-video-camera"></i> Watch Video</h4></a>
				</div>
				<div class="col-md-1">
				</div>
			</div>
		</div>
	</script>
	<script id="signup-tpl" type="text/x-handlebars-template">
		<div class="container h-100 mt-3">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12 mx-auto">						
					<h3 class="text-center text-white">SIGN UP</h3>
					<div class="form-group cam text-center text-white">
						<a href="" data-toggle="modal" data-target="#photo"><img src="img/camera.png" id='profimg' class="img-responsive"></a><br/>
						<span>upload photo</span><br/>
						<hr/>
					</div>
					<div id="photo" class="modal fade" role="dialog">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-header">
									<p class="modal-title text-center w-100 font-weight-bold">Upload Photo</p>
									<span class="close" data-dismiss="modal">&times;</span>
									
								</div>
								<div class="modal-body text-center">
									<button id='but_take' class="btn btn-outline-primary">Take photo</button><br/>
									<button id='but_select' class="btn btn-outline-info mt-1">Select photo from Gallery</button>
									
								</div>
							</div>
						</div>	
					</div>
					<form action="#" class="text-white" name="reg" id="reg">
						<div class="form-group">
							<input type="text" class="form-control" required placeholder="Company Name *" name="cname" id="cname">
						</div>
						<div class="form-group">
							<input type="text" class="form-control" required placeholder="Your Name *" name="name" id="name">
						</div>
						<div class="form-group">
							<input type="tel" class="form-control" required placeholder="Mobile Number *" name="mobile" id="mobile">
						</div>
						<div class="form-group">
							<input type="tel" class="form-control" placeholder="Alternative Number" name="altmobile" id="altmobile">
						</div>
						<div class="form-group">
							<input type="email" class="form-control" placeholder="Email address *" required name="email" id="email">
							<input type="hidden" class="form-control" name="imgname" id="imgname">
						</div>	
						<div class="form-group text-center">
						<a id="" href="Home" class="btn form-btn pt-3 lnk">Home</a>
						<button type="submit" class="btn form-btn reg" name="insert" id="insert" >Submit</button>
						</div>
					</form>	
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>
	<script id="signin-tpl" type="text/x-handlebars-template">
		<div class="container h-100" id="lgmid">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block">
				</div>
				<div class="col-md-10 col-sm-12 mx-auto">
					<h3 class="text-center text-white">SIGN IN</h3><br/>
					<form action="#" class="text-white">								
						<div class="form-group">
							<label for="mobile">Enter Mobile Number: *</label>
							<input type="tel" class="form-control" required name="umobile" id="umobile">
						</div>									
						<div class="form-group text-center">
							<a id="" href="Home" class="btn form-btn pt-3 lnk">Home</a>
							<button type="submit" class="btn form-btn lgn">Login</button>
						</div>
					</form>	
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>
	<script id="otp-tpl" type="text/x-handlebars-template">
		<div class="container h-100" id="lgmid">
			<div class="h-100 row align-items-center">
				<div class="col-md-1 d-none d-md-block"></div>
				<div class="col-md-10 col-sm-12 mx-auto">
					<h3 class="text-center text-white">SIGN IN</h3><br/>
					<form action="#" class="text-white">								
						<div class="form-group">
							<label for="mobile">Enter OTP: *</label>
							<input type="password" class="form-control" required id="otp">
							<input type="hidden" name="cumobile" id="cumobile">
						</div>									
						<div class="form-group text-center">
						<a id="" href="Home" class="btn form-btn pt-3 lnk">Home</a>
						<button type="submit" class="btn form-btn lgnotp">Submit</button>
						</div>
					</form>	
				</div>
				<div class="col-md-1"></div>
			</div>
		</div>
	</script>	
	<script src="phonegap.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
	<script src="js/jquery.min.js"></script>
	<script src="js/popper.min.js"></script>
	<script src="js/bootstrap.min.js"></script>	
	<script src="lib/handlebars.js"></script>
	<script src="js/main.js"></script> 
	<script src="js/jquery-ui.js"></script>
	<script type="text/javascript">
		// If logged in then move to dashboard
		window.onload = function()
		{
			var lgn=window.localStorage.getItem('loginstatus');
			if(lgn == 'true')
			{
				window.location.href="dashboard.html";
			}
		}
		// Change image source and upload photo to server
		function onSuccess(imageURI) {
			// Set image source
			var image = document.getElementById('profimg');
			image.src = imageURI  + '?' + Math.random();

			var options = new FileUploadOptions();
			options.fileKey = "file";
			options.fileName = imageURI.substr(imageURI.lastIndexOf('/') + 1);
			options.mimeType = "image/jpeg";

			var params = {};
			params.value1 = "test";
			params.value2 = "param";

			options.params = params;
			options.chunkedMode = false;

			var ft = new FileTransfer();
			ft.upload(imageURI, "http://www.azillesoft.com/phonegap/database/upload.php", function(result){
				//alert('successfully uploaded ' + result.response);
				$('#imgname').val(result.response);
				$('#photo').modal('hide');				
			}, function(error){
				alert('error : ' + JSON.stringify(error));
			}, options);
		}
		function onFail(message) {
			alert('Failed because: ' + message);
		}
	$(function()
	{
		// open the corresponding page
		$('body').on('click','.lnk',function(e){
			e.preventDefault();
			// Most effect types need no options passed by default
			
			var l=$(this).attr('href').toLowerCase();
			if(l != '#' && l != '')
			{
				if($('#imgname').val())
				{		
					var v = $('#imgname').val();
					if(v.length > 0)
					{
						$.ajax({
							type: "POST",
							url:"http://www.azillesoft.com/phonegap/database/checkuimg.php",
							data : 'm='+v, // post data || get data
							crossDomain: true,
							cache: false,
							success: function(data){
								if(data == 0)
								{
									$('#profimg').attr('src','img/camera.png');
								}
								//console.log(data);						
							}
						});
					}
				}
				var template = Handlebars.compile($("#"+l+"-tpl").html());
				
				if(l == 'welcome')
					window.localStorage.setItem('firstpage',1);
				else
					window.localStorage.setItem('firstpage',0);
			
				var options = {direction:'right'};
				$('.maincontent').html('');
				$( ".maincontent" ).effect( 'slide', options, 300, function(){
					$('.maincontent').html(template);
				});
			}
			
		});
		
		// Check mobile number already registered or not
		$("body").on('blur','#mobile',function(e){
			var v=$(this).val();
			var im = $('#imgname').val();
			if(v.length > 0)
			{
				$.ajax({
					type: "POST",
					url:"http://www.azillesoft.com/phonegap/database/checkumobile.php",
					data : 'm='+v+'&im='+im, // post data || get data
					crossDomain: true,
					cache: false,
					success: function(data){
						if(data == "exists")
						{			
							$('#profimg').attr('src','img/camera.png');
							alert("Mobile number already registered.");
							$("#mobile").val('');
							$("#reg")[0].reset();
							var signinTpl = Handlebars.compile($("#signin-tpl").html());	
							$('.maincontent').html(signinTpl);							
						}						
					}
				});
			}
		});
	
		// take picture from camera
		$('body').on('click','#but_take',function(){
			navigator.camera.getPicture(onSuccess, onFail, { quality: 20,
				destinationType: Camera.DestinationType.FILE_URL 
			});
		});

		// upload select 
		$('body').on('click','#but_select',function(){
			navigator.camera.getPicture(onSuccess, onFail, { quality: 50,
				sourceType: Camera.PictureSourceType.PHOTOLIBRARY, 
				allowEdit: true,
				destinationType: Camera.DestinationType.FILE_URI
			});
		});           
		
		// insert data to server
		$("body").on('click','#insert',function(e){
			e.preventDefault();	
			var cname=$("#cname").val();
			var name=$("#name").val();
			var mobile=$("#mobile").val();
			var amobile=$("#altmobile").val();
			var email=$("#email").val();			
			var imgname=$("#imgname").val();
			if($.trim(cname).length > 0 && $.trim(name).length > 0 && $.trim(mobile).length > 0 && $.trim(email).length > 0)
			{				
				 atpos = email.indexOf("@");
				 dotpos = email.lastIndexOf(".");				 
				 if (atpos < 1 || ( dotpos - atpos < 2 )) {
					alert("Please enter correct email ID")
					$("#email").focus() ;
					return false;
				 }
				 if(isNaN( mobile ) ||$.trim(mobile).length != 10 ) {					
					alert( "Please provide a valid mobile number." );
					$("#mobile").focus() ;
					return false;
				 }
				if( amobile != '' && $.trim(amobile).length != 10 ) {					
					alert( "Please provide a valid alternate number." );
					$("#altmobile").focus() ;
					return false;
				 }		
			
				$.ajax({
					type: "POST",
					url:"http://www.azillesoft.com/phonegap/database/insert.php",
					//dataType : 'json', // data type
					data : $("#reg").serialize(), // post data || get data
					crossDomain: true,
					cache: false,
					beforeSend: function(){ $("#insert").text('Connecting...');},
					success: function(data){
						if(data=="success")
						{
							alert("inserted");
							$("#insert").text('Submit');
							$("#reg")[0].reset();
							var signinTpl = Handlebars.compile($("#signin-tpl").html());	
							$('.maincontent').html(signinTpl);
							
						}
						else if(data=="error")
						{				
							delImg();
							$('#profimg').attr('src','img/camera.png');
							alert("error");							
							//$("#reg")[0].reset();
						}
					}
				});
			}
			else 
			{
				
				alert("Enter all the required fields");
				//$("#reg")[0].reset();
			}
			return false;
		});
		
		
		// Check mobile number registered or not
		$("body").on('blur','#umobile',function(e){
			var v=$(this).val();
			if(v.length > 0)
			{
				$.ajax({
					type: "POST",
					url:"http://www.azillesoft.com/phonegap/database/checkumobile.php",
					data : 'm='+v, // post data || get data
					crossDomain: true,
					cache: false,
					success: function(data){
						if(data == 0)
						{
							alert("Mobile number not registered. Enter Registered mobile Number");
							$("#umobile").val('').focus();
						}						
					}
				});
			}
		});
		// Send OTP to registered mobile
		$("body").on('click','.lgn',function(e){
			e.preventDefault();
			var v=$('#umobile').val();
			if(v.length > 0)
			{
				$.ajax({
					type: "POST",
					url:"http://www.azillesoft.com/phonegap/database/sendotp.php",
					data : 'm='+v, // post data || get data
					crossDomain: true,
					cache: false,
					success: function(data){
						if(data == 0)
						{
							alert("Mobile number not registered. Enter Registered mobile Number");							
							$("#umobile").val('').focus();
						}
						else
						{
							alert("OTP has been sent to your email.");
							var otpTpl = Handlebars.compile($("#otp-tpl").html());	
							$('.maincontent').html(otpTpl);
							$('#cumobile').val(v);
						}						
					}					
				});
			}
			else
			{
				alert("Enter mobile number.");
			}
		});
		// Check OTP 
		$("body").on('click','.lgnotp',function(e){
			e.preventDefault();
			var m=$('#cumobile').val();
			var o=$('#otp').val();
			if(o.length > 0)
			{
				$.ajax({
					type: "POST",
					url:"http://www.azillesoft.com/phonegap/database/checkotp.php",
					data : 'm='+m+'&o='+o, // post data || get data
					crossDomain: true,
					cache: false,
					success: function(data){
						if(data == 0)
						{
							alert("Incorrect OTP");							
							$("#otp").val('').focus();
						}
						else
						{
							window.localStorage.setItem('loginstatus','true');
							window.localStorage.setItem('lgnid',data);
							window.localStorage.setItem('uid',m);
							window.location.href="dashboard.html";
						}						
					}
				});
			}
			else
			{
				alert("Enter OTP.");
			}
		});
	
	
	});
	
	// Delete image from server using cordova plugin file	
	function delImg()
	{
		var path = "http://www.azillesoft.com/phonegap/database/upload";
		var filename = $('#imgname').val();
		window.resolveLocalFileSystemURL(path, function(dir) {
			dir.getFile(filename, {create:false}, function(fileEntry) {
					  fileEntry.remove(function(){
						  // The file has been removed succesfully
					  },function(error){
						  // Error deleting the file
					  },function(){
						 // The file doesn't exist
					  });
			});
		});
	}
 </script>
</html>